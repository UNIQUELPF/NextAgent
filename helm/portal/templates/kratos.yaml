apiVersion: apps/v1
{{- $kratosIdentityProvided := or .Values.kratos.identitySchema (.Files.Glob "files/kratos/identity.schema.json") }}
{{- $kratosTemplateFiles := .Files.Glob "files/kratos/courier/templates/**/*" }}
kind: Deployment
metadata:
  name: {{ include "portal.fullname" . }}-kratos
  labels:
    app.kubernetes.io/component: kratos
    {{- include "portal.labels" . | nindent 4 }}
spec:
  replicas: {{ .Values.kratos.replicaCount }}
  selector:
    matchLabels:
      app.kubernetes.io/component: kratos
      {{- include "portal.selectorLabels" . | nindent 6 }}
  template:
    metadata:
      labels:
        app.kubernetes.io/component: kratos
        {{- include "portal.selectorLabels" . | nindent 8 }}
      annotations:
        checksum/migrations: {{ include (print $.Template.BasePath "/migrations.yaml") . | sha256sum }}
    spec:
      initContainers:
        - name: wait-for-kratos-migrations
          image: postgres:15
          env:
            - name: DATABASE_DSN
              value: {{ printf "postgres://kratos:kratos@%s-postgres:5432/kratos?sslmode=disable" (include "portal.fullname" .) | quote }}
          command:
            - sh
            - -c
            - |
              set -euo pipefail
              until psql "$DATABASE_DSN" -Atqc "SELECT to_regclass('courier_messages') IS NOT NULL;" | grep -q t; do
                echo "waiting for kratos migrations..."
                sleep 2
              done
      {{- if .Values.global.imagePullSecrets }}
      imagePullSecrets:
{{- range .Values.global.imagePullSecrets }}
        - name: {{ . }}
{{- end }}
      {{- end }}
      containers:
        - name: kratos
          image: "{{ .Values.global.imageRegistry }}{{ if .Values.global.imageRegistry }}/{{ end }}{{ .Values.kratos.image }}"
          imagePullPolicy: IfNotPresent
          args:
            - serve
            - --config
            - /etc/config/kratos/kratos.yaml
            - --watch-courier
          ports:
            - containerPort: {{ .Values.kratos.public.servicePort }}
              name: public
            - containerPort: {{ .Values.kratos.admin.servicePort }}
              name: admin
          env:
            - name: DSN
              value: postgres://kratos:kratos@{{ include "portal.fullname" . }}-postgres:5432/kratos?sslmode=disable
          volumeMounts:
            - name: kratos-config
              mountPath: /etc/config/kratos
      volumes:
        - name: kratos-config
          configMap:
            name: {{ include "portal.fullname" . }}-kratos-config
            items:
              - key: kratos.yaml
                path: kratos.yaml
{{- if $kratosIdentityProvided }}
              - key: identity.schema.json
                path: identity.schema.json
{{- end }}
{{- range $path, $_ := $kratosTemplateFiles }}
{{- $rel := trimPrefix "files/kratos/" $path }}
{{- $key := replace $rel "/" "__" }}
              - key: {{ $key }}
                path: {{ $rel }}
{{- end }}
---
apiVersion: v1
kind: Service
metadata:
  name: {{ include "portal.fullname" . }}-kratos-public
  labels:
    {{- include "portal.labels" . | nindent 4 }}
spec:
  type: ClusterIP
  ports:
    - port: {{ .Values.kratos.public.servicePort }}
      name: http
  selector:
    app.kubernetes.io/component: kratos
    {{- include "portal.selectorLabels" . | nindent 4 }}
---
apiVersion: v1
kind: Service
metadata:
  name: {{ include "portal.fullname" . }}-kratos-admin
  labels:
    {{- include "portal.labels" . | nindent 4 }}
spec:
  type: ClusterIP
  ports:
    - port: {{ .Values.kratos.admin.servicePort }}
      name: http
  selector:
    app.kubernetes.io/component: kratos
    {{- include "portal.selectorLabels" . | nindent 4 }}
