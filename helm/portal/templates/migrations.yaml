{{- if .Values.migrations.portal.enabled }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "portal.fullname" . }}-portal-migrate
  labels:
    {{- include "portal.labels" . | nindent 4 }}
spec:
  backoffLimit: 2
  template:
    metadata:
      labels:
        {{- include "portal.selectorLabels" . | nindent 8 }}
    spec:
      restartPolicy: Never
      initContainers:
        - name: wait-for-postgres
          image: postgres:15
          command:
            - sh
            - -c
            - |
              until pg_isready -h {{ include "portal.fullname" . }}-postgres -p 5432 -U postgres; do
                echo "waiting for postgres..."
                sleep 2
              done
          env:
            - name: PGPASSWORD
              value: {{ .Values.postgres.password | quote }}
      {{- if .Values.global.imagePullSecrets }}
      imagePullSecrets:
{{- range .Values.global.imagePullSecrets }}
        - name: {{ . }}
{{- end }}
      {{- end }}
      containers:
        - name: migrate
          image: "{{ .Values.migrations.portal.image }}"
          args:
            - "-path=/migrations"
            - "-database"
            - {{ printf "postgres://portal:portal@%s-postgres:5432/portal?sslmode=disable" (include "portal.fullname" .) | quote }}
            - up
          volumeMounts:
            - name: migrations
              mountPath: /migrations
      volumes:
        - name: migrations
          configMap:
            name: {{ include "portal.fullname" . }}-portal-migrations
{{- end }}

{{- if .Values.migrations.keto.enabled }}
---
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "portal.fullname" . }}-keto-migrate
  labels:
    {{- include "portal.labels" . | nindent 4 }}
spec:
  backoffLimit: 2
  template:
    metadata:
      labels:
        {{- include "portal.selectorLabels" . | nindent 8 }}
    spec:
      restartPolicy: Never
      initContainers:
        - name: wait-for-postgres
          image: postgres:15
          command:
            - sh
            - -c
            - |
              until pg_isready -h {{ include "portal.fullname" . }}-postgres -p 5432 -U postgres; do
                echo "waiting for postgres..."
                sleep 2
              done
          env:
            - name: PGPASSWORD
              value: {{ .Values.postgres.password | quote }}
      {{- if .Values.global.imagePullSecrets }}
      imagePullSecrets:
{{- range .Values.global.imagePullSecrets }}
        - name: {{ . }}
{{- end }}
      {{- end }}
      containers:
        - name: migrate
          image: "{{ .Values.migrations.keto.image }}"
          command:
            - sh
            - -c
            - |
              set -euo pipefail
              keto migrate up --yes --config /etc/config/keto/keto.yaml
          env:
            - name: DSN
              value: postgres://keto:keto@{{ include "portal.fullname" . }}-postgres:5432/keto?sslmode=disable
          volumeMounts:
            - name: keto-config
              mountPath: /etc/config/keto
      volumes:
        - name: keto-config
          configMap:
            name: {{ include "portal.fullname" . }}-keto-config
            items:
              - key: keto.yaml
                path: keto.yaml
{{- if .Values.keto.opl }}
              - key: inline-opl.ts
                path: inline-opl.ts
{{- end }}
{{- $ketoOplFile := .Files.Glob "files/keto/opl.ts" }}
{{- if $ketoOplFile }}
              - key: opl.ts
                path: opl.ts
{{- end }}

{{- end }}

{{- if .Values.migrations.kratos.enabled }}
---
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "portal.fullname" . }}-kratos-migrate
  labels:
    {{- include "portal.labels" . | nindent 4 }}
spec:
  backoffLimit: 2
  template:
    metadata:
      labels:
        {{- include "portal.selectorLabels" . | nindent 8 }}
    spec:
      restartPolicy: Never
      initContainers:
        - name: wait-for-postgres
          image: postgres:15
          command:
            - sh
            - -c
            - |
              until pg_isready -h {{ include "portal.fullname" . }}-postgres -p 5432 -U postgres; do
                echo "waiting for postgres..."
                sleep 2
              done
          env:
            - name: PGPASSWORD
              value: {{ .Values.postgres.password | quote }}
      {{- if .Values.global.imagePullSecrets }}
      imagePullSecrets:
{{- range .Values.global.imagePullSecrets }}
        - name: {{ . }}
{{- end }}
      {{- end }}
      containers:
        - name: migrate
          image: "{{ .Values.migrations.kratos.image }}"
          args:
            - migrate
            - sql
            - -e
            - --yes
          env:
            - name: DSN
              value: postgres://kratos:kratos@{{ include "portal.fullname" . }}-postgres:5432/kratos?sslmode=disable
{{- end }}
