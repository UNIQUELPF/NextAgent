- id: kratos-public
  priority: 300
  match:
    url: {{ printf "%s/<\\.ory/.*>" (include "portal.publicURL" .) | quote }}
    methods:
      - GET
      - POST
      - PUT
      - PATCH
      - DELETE
  authenticators:
    - handler: anonymous
  authorizer:
    handler: allow
  mutators:
    - handler: noop
  upstream:
    url: {{ include "portal.kratosPublicURL" . | quote }}
    strip_path: /.ory

- id: backend-me
  priority: 210
  match:
    url: {{ printf "%s/api/v1/me" (include "portal.publicURL" .) | quote }}
    methods:
      - GET
  authenticators:
    - handler: cookie_session
  authorizer:
    handler: allow
  mutators:
    - handler: header
      config:
        headers:
          X-Session-Subject: "{{ .Subject }}"
          X-Session-User-Type: "{{ with (index .Extra \"user_type\") }}{{ . }}{{ end }}"
          X-Session-Roles: "{{ with (index .Extra \"roles\") }}{{ join \",\" . }}{{ end }}"
          X-Tenant-Id: "{{ with (index .Extra \"tenant_id\") }}{{ . }}{{ end }}"
  upstream:
    url: {{ include "portal.backendInternalURL" . | quote }}

- id: backend-api
  priority: 200
  match:
    url: {{ printf "%s/<api/(?!v1/me$).+>" (include "portal.publicURL" .) | quote }}
    methods:
      - GET
      - POST
      - PUT
      - PATCH
      - DELETE
  authenticators:
    - handler: cookie_session
  authorizer:
    handler: remote_json
    config:
      remote: {{ printf "%s/api/v1/authorize" (include "portal.backendInternalURL" .) | quote }}
      payload: |
        {
          "object": "{{ print .MatchContext.URL.Path }}",
          "action": "{{ print .MatchContext.Method }}",
          "subject": "{{ .Subject }}",
          "user_type": "{{ with (index .Extra \"user_type\") }}{{ . }}{{ end }}",
          "tenant_id": "{{ with (index .Extra \"tenant_id\") }}{{ . }}{{ end }}",
          "roles": "{{ with (index .Extra \"roles\") }}{{ join \",\" . }}{{ end }}"
        }
  mutators:
    - handler: header
      config:
        headers:
          X-Session-Subject: "{{ .Subject }}"
          X-Session-User-Type: "{{ with (index .Extra \"user_type\") }}{{ . }}{{ end }}"
          X-Session-Roles: "{{ with (index .Extra \"roles\") }}{{ join \",\" . }}{{ end }}"
          X-Tenant-Id: "{{ with (index .Extra \"tenant_id\") }}{{ . }}{{ end }}"
  upstream:
    url: {{ include "portal.backendInternalURL" . | quote }}

- id: front-assets
  priority: 150
  match:
    url: {{ printf "%s/<_next/.*>" (include "portal.publicURL" .) | quote }}
    methods:
      - GET
      - HEAD
      - OPTIONS
  authenticators:
    - handler: anonymous
  authorizer:
    handler: allow
  mutators:
    - handler: noop
  upstream:
    url: {{ include "portal.frontendInternalURL" . | quote }}

- id: front-root
  priority: 140
  match:
    url: {{ printf "%s/" (include "portal.publicURL" .) | quote }}
    methods:
      - GET
      - HEAD
      - OPTIONS
  authenticators:
    - handler: anonymous
  authorizer:
    handler: allow
  mutators:
    - handler: noop
  upstream:
    url: {{ include "portal.frontendInternalURL" . | quote }}

- id: front-all
  priority: 100
  match:
    url: {{ printf "%s/<(?!_next/|api/|\\.ory/).+>" (include "portal.publicURL" .) | quote }}
    methods:
      - GET
      - HEAD
      - OPTIONS
      - POST
      - PUT
      - PATCH
      - DELETE
  authenticators:
    - handler: anonymous
  authorizer:
    handler: allow
  mutators:
    - handler: noop
  upstream:
    url: {{ include "portal.frontendInternalURL" . | quote }}
